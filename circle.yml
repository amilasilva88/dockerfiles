machine:
  services:
    - docker
general:
  branches:
    only:
      - master
      - improve_circleci
dependencies:
  pre: 
    - sudo service postgresql stop
  cache_directories:
    - "~/container"
  override:
    - docker info
#    - docker build -t timbira/debian-postgres:9.4 ~/dockerfiles/debian-postgres/9.4 
    - for i in $(ls -1 ~/d/timbira/dockerfiles/postgres |egrep "[0-9]{1,2}\.[0-9]{1,2}.*"); do if [[ -e ~/container/$i.tar ]]; then if [[ -e ~/container/$i.tar ]]; then docker load --input ~/container/$i.tar; fi docker build -t timbira/postgres/$i ~/dockerfiles/postgres/$i && mkdir -p ~/container && docker save --output ~/container/$i.tar timbira/postgres:$i; done
test:
  override:
    #- docker run -d -p 5432:5432 --name 9.4 timbira/debian-postgres:9.4 && docker run -it --net="container:9.4" -e PGPASSWORD="foobar" timbira/debian-postgres:9.4 psql -h 127.0.0.1 -p 5432 -U postgres --command "SELECT version();" && docker stop 9.4
    - for i in $(ls -1 ~/d/timbira/dockerfiles/postgres | egrep "[0-9]{1,2}\.[0-9]{1,2}.*"); do docker run -d --name $i timbira/postgres:$i && docker run -it --net="container:$i" -e PGPASSWORD="foobar" timbira/postgres:$i psql -h 127.0.0.1 -p 5432 -U postgres --command "SELECT version();" && docker stop $i; done
   
notify:
  webhooks:
    - url: https://webhooks.gitter.im/e/b570905592c63eaad9fb
